%% Echo Processing Pipeline - Doctoral Thesis Version
%% Complete Multi-Agent Interaction Sequence
%% Author: Mohamed Nejjar
%% Thesis: "Mitigating Hallucination Potential in User Prompts Through AI-Guided Iterative Refinement"
%% Render: mmdc -i pipeline-sequence.mmd -o pipeline-sequence.svg

%%{init: {
  "themeVariables": {
    "primaryColor": "#002147",
    "primaryTextColor": "#ffffff",
    "primaryBorderColor": "#764ba2",
    "actorBkg": "#002147",
    "actorTextColor": "#ffffff",
    "actorBorder": "#764ba2",
    "signalColor": "#5B7C99",
    "lineColor": "#5B7C99",
    "textColor": "#1E1E1E",
    "noteBkgColor": "#E0E6ED",
    "noteTextColor": "#1E1E1E",
    "noteBorderColor": "#764ba2"
  }
}}%%

sequenceDiagram
    autonumber
    
    participant U as ğŸ‘¤ User
    participant FE as ğŸ–¥ï¸ Frontend<br/>(React)
    participant API as ğŸ”€ API Routes<br/>(FastAPI)
    participant AA as ğŸ” Analyzer<br/>Agent
    participant IA as ğŸ’¡ Initiator<br/>Agent
    participant CA as ğŸ’¬ Conversation<br/>Agent
    participant PA as ğŸ”„ Preparator<br/>Agent
    participant LLM as ğŸ¤– GPT-4<br/>(OpenAI)

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% PHASE 1: INITIAL ANALYSIS
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    rect rgb(0, 33, 71)
        Note over U,LLM: <b>PHASE 1: INITIAL ANALYSIS</b><br/>User submits prompt for hallucination risk assessment
    end

    U->>FE: Enter prompt text
    U->>FE: Select mode (Faithfulness|Factuality|Both)
    FE->>FE: Validate input
    FE->>API: POST /api/analyze<br/>{prompt, mode}
    
    API->>API: Load guidelines XML<br/>(mode â†’ file mapping)
    
    Note over API: mode="both" â†’ both.xml<br/>mode="faithfulness" â†’ faithfulness.xml<br/>mode="factuality" â†’ factuality.xml
    
    API->>AA: analyze(prompt, guidelines)
    
    rect rgb(118, 75, 162)
        Note over AA: <b>ANALYZER AGENT PROCESSING</b>
        AA->>AA: Construct analysis prompt<br/>with 12-pillar taxonomy
        AA->>LLM: Request structured analysis
        LLM-->>AA: XML response with<br/>RISK_n tokens + violations
        AA->>AA: Parse XML response
        AA->>AA: Extract prompt-level violations<br/>(highlightable spans)
        AA->>AA: Extract meta-level violations<br/>(structural issues)
        AA->>AA: Calculate PRD scores
        Note over AA: PRD = Î£(span_i Ã— weight_i) / L<br/>Weights: Medium=1, High=2, Critical=3
    end
    
    AA-->>API: {annotated_prompt,<br/>risk_tokens,<br/>prompt_PRD,<br/>meta_PRD,<br/>violations}
    
    API-->>FE: Analysis response
    FE->>FE: Map RISK_n â†’ color classes<br/>ğŸŸ¡ Medium | ğŸŸ  High | ğŸ”´ Critical
    FE-->>U: Display highlighted prompt<br/>+ PRD gauges<br/>+ violation cards

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% PHASE 2: INITIATOR QUESTIONS
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    rect rgb(0, 33, 71)
        Note over U,LLM: <b>PHASE 2: ENTRY-POINT GENERATION</b><br/>Generate one clarifying question per broken rule
    end

    FE->>API: POST /api/initiate<br/>{violations, prompt}
    API->>IA: generate_questions(violations)
    
    rect rgb(245, 87, 108)
        Note over IA: <b>INITIATOR AGENT PROCESSING</b>
        IA->>IA: Map violations â†’ rules
        IA->>LLM: Request one question<br/>per unique rule
        LLM-->>IA: Focused clarification questions
        IA->>IA: Deduplicate & prioritize<br/>by severity
    end
    
    IA-->>API: {questions: [<br/>  {rule, severity, question},<br/>  ...<br/>]}
    API-->>FE: Initiator questions
    FE-->>U: Display entry-point questions<br/>sorted by priority

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% PHASE 3: CONVERSATIONAL REFINEMENT
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    rect rgb(0, 33, 71)
        Note over U,LLM: <b>PHASE 3: ITERATIVE REFINEMENT</b><br/>Critical dialogue to address identified risks
    end

    U->>FE: Open chat interface
    U->>FE: Send message about<br/>a specific risk
    FE->>API: POST /api/refine<br/>{message, context, history}
    API->>CA: chat(message, context)
    
    rect rgb(0, 242, 254)
        Note over CA: <b>CONVERSATION AGENT PROCESSING</b>
        CA->>CA: Load analysis context
        CA->>CA: Review conversation history
        CA->>LLM: Request contextual response<br/>(critical, non-yes-man)
        LLM-->>CA: Refinement suggestion
        CA->>CA: Validate suggestion<br/>addresses specific rules
        Note over CA: Key behavior: Agent challenges<br/>vague fixes, requests specifics,<br/>maintains guideline adherence
    end
    
    CA-->>API: {response, addressed_rules}
    API-->>FE: Chat response
    FE-->>U: Display Echo's suggestion

    loop Refinement Iteration
        U->>FE: Continue dialogue
        FE->>API: POST /api/refine
        API->>CA: chat(...)
        CA->>LLM: Continue refinement
        LLM-->>CA: Updated suggestions
        CA-->>API: Response
        API-->>FE: Updated chat
        FE-->>U: Display progress
    end

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% PHASE 4: RE-ANALYSIS CYCLE
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    rect rgb(0, 33, 71)
        Note over U,LLM: <b>PHASE 4: PROMPT SYNTHESIS & RE-ANALYSIS</b><br/>Preparator synthesizes conversation insights
    end

    U->>FE: Click "Re-Analyze"
    FE->>API: POST /api/prepare<br/>{original_prompt,<br/>conversation_history,<br/>user_edits}
    API->>PA: synthesize(...)
    
    rect rgb(56, 249, 215)
        Note over PA: <b>PREPARATOR AGENT PROCESSING</b>
        PA->>PA: Analyze conversation<br/>for semantic intent
        PA->>PA: Extract mitigations<br/>(NOT copying text)
        PA->>LLM: Request prompt reconstruction
        LLM-->>PA: Refined prompt preview
        PA->>PA: Validate no conversation<br/>text leakage
        Note over PA: Critical: Uses conversation as<br/>CONTEXT only, synthesizes<br/>improvements into original prompt
    end
    
    PA-->>API: {refined_prompt, changes_summary}
    API-->>FE: Synthesis result
    FE-->>U: Display refined prompt preview<br/>+ change summary
    
    U->>FE: Confirm or edit preview
    FE->>FE: Update prompt editor

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% PHASE 5: VALIDATION CYCLE
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    rect rgb(0, 33, 71)
        Note over U,LLM: <b>PHASE 5: VALIDATION</b><br/>Re-analyze refined prompt to measure improvement
    end

    FE->>API: POST /api/analyze<br/>{refined_prompt, mode}
    API->>AA: analyze(refined_prompt, guidelines)
    AA->>LLM: Request fresh analysis
    LLM-->>AA: Updated risk assessment
    AA->>AA: Calculate new PRD scores
    AA-->>API: New analysis results
    API-->>FE: Updated metrics
    FE->>FE: Compare PRD: before vs after
    FE-->>U: Display improvement metrics<br/>ğŸ¯ PRD reduction achieved

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% PHASE 6: EXPORT
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    rect rgb(0, 33, 71)
        Note over U,LLM: <b>PHASE 6: EXPORT</b><br/>Save artifacts for deployment
    end

    U->>FE: Click "Export"
    FE->>FE: Generate export package
    Note over FE: Formats: JSON, Markdown, PDF<br/>Contents: Original, Refined,<br/>PRD scores, Conversation log
    FE-->>U: Download export file
