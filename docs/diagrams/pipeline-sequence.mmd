%% Processing Pipeline Sequence (Authoritative Source) - Updated for Agent Architecture
%% Render with: mmdc -i pipeline-sequence.mmd -o pipeline-sequence.svg

sequenceDiagram
  participant U as User
  participant FE as Frontend
  participant Route as /api/analyze
  participant Facade as LLM Facade
  participant Analyzer as Analyzer Agent
  participant MODEL as OpenAI GPT

  U->>FE: Click "Analyze"
  FE->>Route: POST /api/analyze { prompt, mode }
  Route->>Facade: analyze_prompt(prompt, mode)
  Facade->>Analyzer: analyze_prompt(prompt, mode)
  
  Note over Analyzer: Load guidelines XML<br/>(faithfulness/factuality/both)
  
  Analyzer->>MODEL: completion request with guidelines
  MODEL-->>Analyzer: raw structured response
  
  Note over Analyzer: Parse XML risk assessment<br/>Extract RISK_n tokens<br/>Calculate PRD scores
  
  Analyzer-->>Facade: analyzed data
  Facade-->>Route: {annotated_prompt, risk_tokens, risk_assessment}
  Route-->>FE: JSON artifacts
  
  Note over FE: Map RISK_n â†’ color classes<br/>Render highlighted view
  
  FE-->>U: Highlighted analysis + risk dashboard
