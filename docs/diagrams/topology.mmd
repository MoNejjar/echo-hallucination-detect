%% System Topology Diagram (Authoritative Source) - Updated for Agent Architecture
%% Render with: mmdc -i topology.mmd -o topology.svg

flowchart TB
  subgraph Browser[Client - React / Vite]
    UI[Prompt Editor & Panels]
    HL[Highlight Renderer]
    Chat[Refinement Chat]
    ReAnalyze[Re-Analyze Dialog]
    APIClient[Typed API Layer]
  end

  subgraph API[FastAPI Backend]
    Router[Route Layer]
    AnalyzeRoute[/api/analyze]
    RefineRoute[/api/refine]
    PrepareRoute[/api/prepare]
    Sanitizer[Input Sanitizer]
    
    subgraph Agents[Specialized Agents]
      LLMFacade[LLM Facade]
      AnalyzerAgent[Analyzer Agent]
      ConversationAgent[Conversation Agent]
      Preparator[Preparator Service]
    end
    
    Logger[Structured Logger]
  end

  subgraph OpenAI[External LLM]
    GPT[(GPT-4)]
  end

  UI --> APIClient
  Chat --> APIClient
  ReAnalyze --> APIClient
  
  APIClient --> Router
  Router --> AnalyzeRoute
  Router --> RefineRoute
  Router --> PrepareRoute
  
  AnalyzeRoute --> Sanitizer --> LLMFacade
  RefineRoute --> LLMFacade
  PrepareRoute --> Preparator
  
  LLMFacade --> AnalyzerAgent
  LLMFacade --> ConversationAgent
  
  AnalyzerAgent --> GPT
  ConversationAgent --> GPT
  Preparator --> GPT
  
  GPT --> AnalyzerAgent
  GPT --> ConversationAgent
  GPT --> Preparator
  
  AnalyzerAgent --> AnalyzeRoute
  ConversationAgent --> RefineRoute
  Preparator --> PrepareRoute
  
  AnalyzeRoute --> APIClient --> HL
  RefineRoute --> APIClient --> Chat
  PrepareRoute --> APIClient --> ReAnalyze
  
  Logger -. observability .- Router
