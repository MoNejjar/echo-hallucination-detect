%% Echo User Journey - Doctoral Thesis Version
%% Complete User Experience Flow with Decision Points
%% Author: Mohamed Nejjar
%% Thesis: "Mitigating Hallucination Potential in User Prompts Through AI-Guided Iterative Refinement"
%% Render: mmdc -i user-flow.mmd -o user-flow.svg

flowchart TB
    %% ═══════════════════════════════════════════════════════════════
    %% ENTRY PHASE
    %% ═══════════════════════════════════════════════════════════════
    
    subgraph Entry["<b>ENTRY PHASE</b><br/>Prompt Composition"]
        Start([🚀 Start])
        Input["<b>Input Prompt</b><br/>━━━━━━━━━━━━━━<br/>• Direct text entry<br/>• File upload (.txt, .md)<br/>• Paste from clipboard"]
        ModeSelect{"<b>Select Analysis Mode</b><br/>━━━━━━━━━━━━━━<br/>Which risk type?"}
        Faith["Faithfulness<br/>Context adherence"]
        Fact["Factuality<br/>World knowledge"]
        Both["Both<br/>Comprehensive"]
    end

    %% ═══════════════════════════════════════════════════════════════
    %% ANALYSIS PHASE
    %% ═══════════════════════════════════════════════════════════════
    
    subgraph Analysis["<b>ANALYSIS PHASE</b><br/>Risk Assessment"]
        Analyze["<b>Run Analysis</b><br/>━━━━━━━━━━━━━━<br/>Analyzer Agent<br/>processes prompt"]
        Processing["<b>Processing</b><br/>━━━━━━━━━━━━━━<br/>• Load 12-pillar guidelines<br/>• Pattern matching<br/>• PRD calculation"]
        Results["<b>View Results</b><br/>━━━━━━━━━━━━━━<br/>• Highlighted prompt<br/>• PRD gauges<br/>• Violation cards"]
    end

    %% ═══════════════════════════════════════════════════════════════
    %% INTERPRETATION PHASE
    %% ═══════════════════════════════════════════════════════════════
    
    subgraph Interpretation["<b>INTERPRETATION PHASE</b><br/>Understanding Risks"]
        ReviewPRD{"<b>Review PRD Scores</b><br/>━━━━━━━━━━━━━━<br/>prompt_PRD | meta_PRD"}
        LowRisk["✅ Low Risk<br/>PRD < 20%<br/>Prompt well-structured"]
        MedRisk["⚠️ Moderate Risk<br/>20% ≤ PRD < 50%<br/>Some improvements needed"]
        HighRisk["🔴 High Risk<br/>PRD ≥ 50%<br/>Significant revision needed"]
        ViewHighlights["<b>Examine Highlights</b><br/>━━━━━━━━━━━━━━<br/>🟡 Medium | 🟠 High | 🔴 Critical"]
        ViewViolations["<b>Read Violation Details</b><br/>━━━━━━━━━━━━━━<br/>Pillar + Rule + Mitigation"]
        ViewQuestions["<b>Review Initiator Questions</b><br/>━━━━━━━━━━━━━━<br/>One question per broken rule"]
    end

    %% ═══════════════════════════════════════════════════════════════
    %% REFINEMENT PHASE
    %% ═══════════════════════════════════════════════════════════════
    
    subgraph Refinement["<b>REFINEMENT PHASE</b><br/>Iterative Improvement"]
        DecideRefine{"<b>Refine Prompt?</b>"}
        OpenChat["<b>Open Chat Interface</b><br/>━━━━━━━━━━━━━━<br/>Conversational Agent"]
        Converse["<b>Discuss Risks</b><br/>━━━━━━━━━━━━━━<br/>• Ask clarification questions<br/>• Receive suggestions<br/>• Critical (non-yes-man) feedback"]
        ApplySuggestion["<b>Apply Suggestions</b><br/>━━━━━━━━━━━━━━<br/>Incorporate improvements"]
        MoreRefine{"<b>More Refinement?</b>"}
    end

    %% ═══════════════════════════════════════════════════════════════
    %% RE-ANALYSIS PHASE
    %% ═══════════════════════════════════════════════════════════════
    
    subgraph ReAnalysis["<b>RE-ANALYSIS PHASE</b><br/>Validation Cycle"]
        PrepareReAnalyze["<b>Prepare Re-Analysis</b><br/>━━━━━━━━━━━━━━<br/>Preparator Agent<br/>synthesizes conversation"]
        PreviewRefined["<b>Preview Refined Prompt</b><br/>━━━━━━━━━━━━━━<br/>• See changes summary<br/>• Edit if needed"]
        ConfirmRefine{"<b>Confirm Preview?</b>"}
        ReAnalyze["<b>Re-Analyze</b><br/>━━━━━━━━━━━━━━<br/>Fresh analysis on<br/>refined prompt"]
        ComparePRD["<b>Compare PRD</b><br/>━━━━━━━━━━━━━━<br/>Before vs After<br/>🎯 Measure improvement"]
        Satisfied{"<b>PRD Acceptable?</b>"}
    end

    %% ═══════════════════════════════════════════════════════════════
    %% EXIT PHASE
    %% ═══════════════════════════════════════════════════════════════
    
    subgraph Exit["<b>EXIT PHASE</b><br/>Export & Deploy"]
        Export["<b>Export Results</b><br/>━━━━━━━━━━━━━━<br/>• JSON (with metadata)<br/>• Markdown<br/>• PDF report"]
        Deploy["<b>Deploy Prompt</b><br/>━━━━━━━━━━━━━━<br/>Use in production<br/>with reduced risk"]
        End([🏁 End])
    end

    %% ═══════════════════════════════════════════════════════════════
    %% CONNECTIONS
    %% ═══════════════════════════════════════════════════════════════
    
    %% Entry Phase Flow
    Start --> Input
    Input --> ModeSelect
    ModeSelect -->|"Faithfulness"| Faith
    ModeSelect -->|"Factuality"| Fact
    ModeSelect -->|"Both"| Both
    Faith --> Analyze
    Fact --> Analyze
    Both --> Analyze

    %% Analysis Phase Flow
    Analyze --> Processing
    Processing --> Results

    %% Interpretation Phase Flow
    Results --> ReviewPRD
    ReviewPRD -->|"< 20%"| LowRisk
    ReviewPRD -->|"20-50%"| MedRisk
    ReviewPRD -->|"> 50%"| HighRisk
    LowRisk --> DecideRefine
    MedRisk --> ViewHighlights
    HighRisk --> ViewHighlights
    ViewHighlights --> ViewViolations
    ViewViolations --> ViewQuestions
    ViewQuestions --> DecideRefine

    %% Refinement Phase Flow
    DecideRefine -->|"Yes"| OpenChat
    DecideRefine -->|"No - Accept"| Export
    OpenChat --> Converse
    Converse --> ApplySuggestion
    ApplySuggestion --> MoreRefine
    MoreRefine -->|"Yes"| Converse
    MoreRefine -->|"No"| PrepareReAnalyze

    %% Re-Analysis Phase Flow
    PrepareReAnalyze --> PreviewRefined
    PreviewRefined --> ConfirmRefine
    ConfirmRefine -->|"Yes"| ReAnalyze
    ConfirmRefine -->|"Edit"| PreviewRefined
    ReAnalyze --> ComparePRD
    ComparePRD --> Satisfied
    Satisfied -->|"Yes"| Export
    Satisfied -->|"No - Iterate"| OpenChat

    %% Exit Phase Flow
    Export --> Deploy
    Deploy --> End

    %% ═══════════════════════════════════════════════════════════════
    %% STYLING - Preserved Color Scheme
    %% ═══════════════════════════════════════════════════════════════
    
    style Entry fill:#002147,stroke:#764ba2,stroke-width:3px,color:#ffffff
    style Analysis fill:#002147,stroke:#f5576c,stroke-width:3px,color:#ffffff
    style Interpretation fill:#002147,stroke:#00f2fe,stroke-width:3px,color:#ffffff
    style Refinement fill:#002147,stroke:#38f9d7,stroke-width:3px,color:#ffffff
    style ReAnalysis fill:#002147,stroke:#fee140,stroke-width:3px,color:#ffffff
    style Exit fill:#002147,stroke:#764ba2,stroke-width:3px,color:#ffffff

    %% Node Styling
    style Start fill:#764ba2,stroke:#764ba2,stroke-width:2px,color:#ffffff
    style End fill:#38f9d7,stroke:#38f9d7,stroke-width:2px,color:#002147
    style LowRisk fill:#38f9d7,stroke:#38f9d7,stroke-width:2px,color:#002147
    style MedRisk fill:#fee140,stroke:#fee140,stroke-width:2px,color:#002147
    style HighRisk fill:#f5576c,stroke:#f5576c,stroke-width:2px,color:#ffffff

    linkStyle default stroke:#5B7C99,stroke-width:2px
